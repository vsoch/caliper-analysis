<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v2.min.js?2.8.1"></script>

<style>
#controls {
  position: absolute:
  top: 10px;
  left: 30px;
}
</style>
<body>
<div id="controls">
 <select id="version_selector" onchange="update_graph(this)">
 </select>
</div>
<script>

var margin = {top: 400, right: 100, bottom: 100, left: 200},
    width = 1400,
    height = 800;


function generate_plot(version) {
    version = version || "38"

    var element = document.getElementById("plotarea");
    if (element) {
        element.parentNode.removeChild(element);    
    }

    var svg = d3.select("body").append("svg")
        .attr("id", "plotarea")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("rect")
        .attr("class", "background")
        .attr("width", width)
        .attr("height", height);

    // Create a matrix for data, x is test, y is tensorflow version, and labels
    var matrix = []
    var row = []
    var rowLabels = []
    var columnLabels = new Set()
    var row_version = window.data[version][0]['y_tensorflow']

    // Derive column labels from first entry
    for (var i = 0; i < window.data[version].length; i++) {
        columnLabels.add(window.data[version][i]["x_name"])
    }

    console.log(columnLabels)    
    columnLabels = Array.from(columnLabels);
    console.log(columnLabels)    
    console.log(columnLabels.length)

    for (var i = 0; i < window.data[version].length; i++) {
        if (row_version != window.data[version][i]['y_tensorflow']) {
            matrix.push(row)
            var numcols = row.length
            row_version = window.data[version][i]['y_tensorflow']
            rowLabels.push(window.data[version][i]['y_tensorflow'])
            row = [window.data[version][i]]
        } else {
            row.push(window.data[version][i])
        }
    }
    var numrows = matrix.length

    var x = d3.scale.ordinal()
        .domain(d3.range(numcols))
        .rangeBands([0, width]);

    var y = d3.scale.ordinal()
        .domain(d3.range(numrows))
        .rangeBands([0, height]);

    var row = svg.selectAll(".row")
        .data(matrix)
      .enter().append("g")
        .attr("class", "row")
        .attr("transform", function(d, i) { return "translate(0," + y(i) + ")"; });

    row.selectAll(".cell")
        .data(function(d) { return d; })
      .enter().append("rect")
        .attr("class", "cell")
        .attr("x", function(d, i) { return x(i); })
        .attr("width", x.rangeBand())
        .attr("height", y.rangeBand())
        .style("stroke-width", 0);

    row.append("line")
        .attr("x2", width);

    row.append("text")
        .attr("x", 0)
        .attr("y", y.rangeBand() / 2)
        .attr("dy", ".32em")
        .style("font-size", "10px")
        .attr("text-anchor", "end")
        .text(function(d, i) { return rowLabels[i]; });

    var column = svg.selectAll(".column")
        .data(columnLabels)
      .enter().append("g")
        .attr("class", "column")
        .style("font-size", "10px")
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

    column.append("line")
        .attr("x1", -width);

    column.append("text")
        .attr("x", 6)
        .attr("y", y.rangeBand() / 2)
        .attr("dy", ".32em")
        .style("font-size", "10px")
        .attr("text-anchor", "start")
        .text(function(d, i) {return d; });

    row.selectAll(".cell")
        .data(function(d, i) { return matrix[i]; })
        // 1 indicates error, 0 indicates success, -1 is didn't run
        .style("fill", function(d, i) {
           if (d['retval'] == -1) {
               return "black";
           } else if (d['retval'] == 0) {
               return "green";
           }
           return "red"
        });
}

// Change version on select change
update_graph = function(selector) {
   console.log(selector);
   generate_plot(selector.value);
}

d3.json("test-results-by-python.json", function(data) {
    window.data = data

    // Keep track of versions to cycle through
    var versions = Object.keys(window.data);
    var selector = document.getElementById("version_selector");
    for (var i = 0; i < versions.length; i++) {        
        var option = document.createElement("option");
        option.text = "Python Version " + versions[i];  
        option.value = versions[i]
        selector.appendChild(option);
    }

    generate_plot(versions[0])

});
</script>
